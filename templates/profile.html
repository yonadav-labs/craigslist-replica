{% extends "base.html" %} 
{% load staticfiles %} 

{% block extra_css %}
<link rel='stylesheet' id='dropdown-menu-style-css' href='/static/css/my-ads.css' type='text/css' media='all' /> 
<link rel='stylesheet' id='dropdown-menu-style-css' href='/static/css/dropdown-menu-style.css?v=1' type='text/css' media='all' /> 

{% endblock %} 

{% block page_content %}

<div id="page" class="site">
    <div class="site-inner">
        <div id="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="admin-content-menu-and-content-section clearfix">
                        <!-- Content Left Section -->
                        <div class="col-md-2 col-sm-12 md-media-full-widht no-padding admin-content-left-section">
                            <!-- Logo Section -->
                            <div class="logo-section clearfix">

                                <div class="navbar-brand-profile">
                                    <a href="/" class="custom-logo-link" rel="home" itemprop="url"><img width="240" height="67" src="/static/img/cropped-logo.png" class="custom-logo" alt="" itemprop="logo" /></a>
                                </div>
                            </div>
                            <!-- End Logo Section -->

                            <!-- Header -->

                            <header>
                                <div class="left-menu-bar">
                                    <div class="cd-dropdown-wrapper">
                                        <div class="menu-button-center">
                                            <a class="cd-dropdown-trigger" href="#0"><i class="fa fa-bars" aria-hidden="true"></i></a>
                                        </div>

                                        <nav class="cd-dropdown">
                                            <a href="#0" class="cd-close">Close</a>
                                            <div class="menu-profile-side-menu-container">
                                                <ul id="menu-profile-side-menu" class="cd-dropdown-content">
                                                    <li id="menu-item-42" class="home menu-item menu-item-type-custom menu-item-object-custom menu-item-42"><a href="/profile/" class="">Home</a></li>
                                                    {% if user.is_authenticated %}
                                                        <li id="menu-item-43" class="ads menu-item menu-item-type-custom menu-item-object-custom menu-item-43"><a href="/my-ads" class="">My Ads</a></li>
                                                        <li id="menu-item-44" class="account menu-item menu-item-type-custom menu-item-object-custom menu-item-44"><a href="#/my-account" class="">My Account</a></li>
                                                        <li id="menu-item-260" class="account menu-item menu-item-type-post_type menu-item-object-page menu-item-260"><a href="#/my-subscribe" class="">My Subscribe</a></li>
                                                        <li id="menu-item-45" class="favorites menu-item menu-item-type-custom menu-item-object-custom menu-item-45"><a href="/my-favourites" class="">My Favorites</a></li>
                                                        <li id="menu-item-46" class="logout menu-item menu-item-type-custom menu-item-object-custom menu-item-46"><a href="/logout" class="">Log Out</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </nav>
                                        <!-- .cd-dropdown -->
                                    </div>
                                </div>
                            </header>
                            <!-- End Header -->
                        </div>

                        <div class="col-md-10 col-sm-12 md-media-full-widht no-padding">
                            <!-- Content Right Header -->
                            <div class="col-sm-12 no-padding">
                                <!-- Header User Section -->
                                <div class="header-user-section clearfix">
                                {% if user.is_authenticated %}
                                    <div class="header-user-section-ico">
                                        <a href="#"><img src="/static/img/big_avatar.png" alt=""></a>
                                    </div>
                                    <div class="header-user-section-message-to-ico">
                                        <a href="#/my-messages">
                                            <i class="fa fa-envelope" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                    <div class="header-user-section-welcome">
                                        Welcome, {{ user.username }}!
                                    </div>
                                {% endif %}
                                </div>
                                <!-- End Header User Section -->
                            </div>

                            {% block right_content %}
                            <div class="col-sm-12">
                                <div class="content-right-content">
                                    <nav class="breadcrumb">                                        
                                    </nav>
                                    <div id="container"></div>

                                    <!-- Content Full Select Country -->
                                    <h3 id="title_of_list"></h3>

                                    <div class="content-select-country clearfix">   
                                    </div>

<!--                                     <div class="content-recent-ads ads_list">
                                        <h3>Recent Ads</h3>
                                    </div>
 -->

                                    <div class="btn-view-all-center">
                                        <a href="" class="btn btn-default btn-view-all">
                                            View All Ads
                                        </a>
                                    </div>

                                </div>
                                <div class="loader_content"></div>

                            </div>
                            {% endblock %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} 

{% block extra_js %}

{% block load_highcharts_js %}
<script src="/static/js/highmaps.js"></script>
<script src="/static/js/index.js"></script>
{% endblock %}

{% block own_js %}
<script type="text/javascript">
    var baseMapPath = "https://code.highcharts.com/mapdata/";
    var mapName = 'custom/world';
    var sec_name, isState;

    analyseHash();
    loadMap();

    function analyseHash() {
        sec_name = '';
        isState = false;        

        if (location.hash) {
            var urls = location.hash.substring(1).split('@');
            mapName = urls[0];

            if (urls.length > 1) {
                sec_name = urls[1];
                isState = true;
            }
        }

        if (!isState)
            findSecname();        
    }

    function loadMap() {
        // console.log(mapName);
        // console.log(sec_name);
        // console.log(isState);
        breadcrumb();
        showRegions();

        if (Highcharts.charts[0]) {
            Highcharts.charts[0].showLoading('<i class="fa fa-spinner fa-spin fa-2x"></i>');
        }

        if (Highcharts.maps[mapName]) {
            mapReady();
        } else {
            $.getScript(baseMapPath+mapName+'.js', mapReady);
        }        
    }    

    function breadcrumb() {
        jQuery.ajax({
            type: 'get',
            url: '/breadcrumb',
            data: {
                mapName: mapName,
                sec_name: sec_name,
                is_state: isState
            },
            success: function(res) {
                $('.breadcrumb').html(res);
            }
        });   
    }

    function showRegions() {
        jQuery.ajax({
            type: 'get',
            url: '/get_regions',
            data: {
                mapName: mapName,
                sec_name: sec_name,
                is_state: isState
            },
            success: function(res) {
                $('#title_of_list').html(res.title);
                $('.content-select-country').html(res.html);
                $('.btn-view-all').attr('href', res.link);
            }
        });        
    }

    function mapReady() {
        var mapGeoJSON = Highcharts.maps[mapName],
            data = [];

        $.each(mapGeoJSON.features, function(index, feature) {
            data.push({
                key: feature.properties['hc-key'],
                value: index
            });
        });

        $("#container").highcharts('Map', {
            title: {
                text: ''
            },
            mapNavigation: {
                enabled: true,
            },
            colorAxis: {
                min: 0,
                stops: [
                    [0, '#EFEFFF'],
                    [0.5, Highcharts.getOptions().colors[0]],
                    [1, Highcharts.Color(Highcharts.getOptions().colors[0]).brighten(-0.5).get()]
                ]
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'bottom'
            },

            series: [{
                data: data,
                mapData: mapGeoJSON,
                joinBy: ['hc-key', 'key'],
                name: 'Random data',
                states: {
                    hover: {
                        color: Highcharts.getOptions().colors[2]
                    }
                },
                dataLabels: {
                    //enabled: showDataLabels,
                    //format: '{point.name}',
                    formatter: function() {
                        return mapName === 'custom/world' ?
                            (this.point.properties && this.point.properties['hc-a2']) :
                            this.point.name;
                    }
                },
                point: {
                    events: {
                        // On click, look for a detailed map
                        click: function() {
                            var key = this.key;
                            var mapname;

                            sec_name = '';
                            mapname = mapName;
                            mapName = 'countries/' + key.substr(0, 2) + '/' + key + '-all';
                            isState = false;
                            findSecname();

                            if (sec_name) { // available data for highcharts
                                location.hash = mapName;
                                loadMap();
                            } else {
                                mapName = mapname;
                            }
                        }
                    }
                }
            }, {
                type: 'mapline',
                name: "Separators",
                data: Highcharts.geojson(mapGeoJSON, 'mapline'),
                nullColor: 'gray',
                showInLegend: false,
                enableMouseTracking: false
            }]
        });        
    }

    function findSecname() {
        $.each(Highcharts.mapDataIndex, function(mapGroup, maps) {
            if (mapGroup !== "version") {
                $.each(maps, function(desc, path) {
                    if (mapName+'.js' == path)
                        sec_name = desc.split(',')[0];
                });
            }
        });                            
    }    

    function findMapname(state) {
        var secname, mapname='';
        $.each(Highcharts.mapDataIndex, function(mapGroup, maps) {
            if (mapGroup !== "version") {
                $.each(maps, function(desc, path) {
                    secname = desc.split(',')[0];
                    if (secname == state) {
                        mapname = path.slice(0, -3);
                        return false;
                    }
                });
            }
        });          

        return mapname;
    }

    jQuery("body").on('click', '.country-list li', function() {
        var key = $(this).data('id');
        mapName = 'countries/'+key+'/'+key+'-all';
        isState = false;
        location.hash = mapName;
        loadMap();
    });

    $("body").on('click', '.get_category_by_location', function() {
        var city_id = $(this).data('id');
        var city_name = $(this).text();

        jQuery.ajax({
            type: 'get',
            url: '/get_category_by_location_id',
            data: {
                city: city_id
            },
            success: function(data) {
                $('#title_of_list').html('Select Category');
                $('.content-select-country').html(data);
                $('.btn-view-all').attr('href', '/region-ads/'+city_id);
                $('.breadcrumb').append('<span class="breadcrumb-item city-brcm" href="#"><i class="fa fa-long-arrow-right" aria-hidden="true"></i>'+city_name+'</span>');
            }
        });
    });    

    $("body").on('click', '.region_id', function() {
        sec_name = $(this).data('id');
        var mapname = findMapname(sec_name);
        if (mapname) 
            mapName = mapname;
        
        location.hash = mapName + '@' + sec_name;
        isState = true;
        loadMap();
    });    

    $("body").on('click', 'a.breadcrumb-item', function() {
        location.hash = $(this).data('mapname');
        analyseHash();
        loadMap();
    });
</script>
{% endblock %}

<script type="text/javascript">
    //open/close mega-navigation for mobile
    $('.cd-dropdown-trigger').on('click', function(event) {
        event.preventDefault();
        toggleNav();
    });

    //close meganavigation
    $('.cd-dropdown .cd-close').on('click', function(event) {
        event.preventDefault();
        toggleNav();
    });

    function toggleNav() {
        var navIsVisible = (!$('.cd-dropdown').hasClass('dropdown-is-active')) ? true : false;
        $('.cd-dropdown').toggleClass('dropdown-is-active', navIsVisible);
        $('.cd-dropdown-trigger').toggleClass('dropdown-is-active', navIsVisible);
        if (!navIsVisible) {
            $('.cd-dropdown').one('webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend', function() {
                $('.has-children ul').addClass('is-hidden');
                $('.move-out').removeClass('move-out');
                $('.is-active').removeClass('is-active');
            });
        }
    }
</script>
{% endblock %}