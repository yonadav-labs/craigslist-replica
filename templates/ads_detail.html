{% extends "profile.html" %} 
{% load staticfiles %} 
{% load extra %}

{% block own_css %}
<link href="/static/star-rating/star-rating.css" rel="stylesheet">
{% endblock %} 

{% block right_content %}
    <!-- Content Right Content -->

    <div class="col-sm-12 full-h">
        <div class="content-right-content ad-view">
            <nav class="breadcrumb">
              <a class="breadcrumb-item" href="/profile/">worldwide<i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
              {% if post.region %}
              <a class="breadcrumb-item" href="#">{{ post.region.state.country.name }}<i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
              <a class="breadcrumb-item" href="#">{{ post.region.state.name }}<i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
              <a class="breadcrumb-item" href="#">{{ post.region.name }}<i class="fa fa-long-arrow-right" aria-hidden="true"></i></a>
              {% endif %}
              <span class="breadcrumb-item active">{{ post.category.name }}</span>
            </nav>

            <div class="main-product">
                <div class="col-md-12">
                    <div class="col-md-12 no-padding">
                        <h4 style="font-size: 22px; color: black; line-height: 24px;">{{ post.title }}</h4>
                    </div>
                    <div class="col-md-12 no-padding" style="margin-top: 16px;">
                        <div class="col-md-11 no-padding" style="margin-bottom: 15px;">Posted on {{ post.created_at }}</div>
                        {% if user != post.owner %}
                        <div class="col-md-1 no-padding favourite {% if favourite %} like {% endif %}">
                            <i class="fa fa-heart-o" aria-hidden="true"></i>
                            <i class="fa fa-heart" aria-hidden="true"></i>
                            <span>Favourite</span>
                        </div>                    
                        {% endif %}                   
                    </div>                
                </div>
                <div class="col-md-6">
                    <div class="product-img col-md-12" style="margin-bottom: 20px;">
                        <a href="#"><img class="first_image" src="/static/media/{{ first_image }}"></a>
                    </div>
                    {% for img in images %}
                        <div class="col-md-3 col-xs-6">
                            <a href="#"><img onclick="set_image(this);" class="img-responsive" src="/static/media/{{ img.name }}" alt=""></a>
                        </div>
                    {% endfor %}
                    <div class="clearfix"></div>
                </div>
                <div class="col-md-6">
                    <div class="col-md-12 no-padding" style="margin-top: 18px;">
                        <div class="star-profile">
                            <a href="/user_show/{{ post.owner.id }}">
                                <img src="/static/media/avatar/{{ post.owner.avatar }}" width="80" height="80">
                            </a>
                            <div class="star-profile-name" style="display: inline-block;">
                                <a href="/user_show/{{ post.owner.id }}" class="username_on_detail">{{ post.owner.first_name }} {{ post.owner.last_name }}</a>
                                <input id="rating-owner" value="{{ post.owner|rating }}"/>
                            </div>
                            {% if post.owner == user %}
                                <a class="btn btn-default btn-reply" href="/post-ads/{{ post.id }}">Edit</a>
                            {% else %}
                                <button class="btn btn-default btn-reply">Reply</button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="clearfix"></div>
                    <div class="reply-post hidden">
                        <div>
                            <label>Your email: </label>
                            <input type="email" id="from_remail">                                
                        </div>

                        <textarea id="reply-body">                            
                        </textarea>
                        <button class="btn btn-default" id="send_remail">Send</button>
                    </div>
                    <div class="main-product-info">
                        <div class="product-location-info">
                            <div class="product-location-info-left">
                                <span>Location</span>
                                {% if post.region %}
                                    <h6>{{ post.region.state.country.name }}</h6>
                                {% else %}
                                    <h6>Global</h6>
                                {% endif %}
                            </div>
                            <div class="product-location-info-left">
                                <span>Category</span>
                                <h6>{{ post.category.parent.name }} / {{ post.category.name }}</h6>
                            </div>
                            {% if post.price %}
                            <div class="product-location-info-left m-t-15">
                                <span>Price</span>
                                <h6><b>${{ post.price }}</b></h6>
                            </div>
                            {% endif %}
                        </div>
                        <div class="product-text">
                            <span>Description</span>
                            <p>{{ post.content }}</p>
                        </div>

                        <div class="email_to_friend">
                            Email to friend
                        </div>
                        <div class="hidden femail_body">
                            <label class="col-md-3 col-xs-12">Your email: </label>
                            <input class="col-md-4" type="email" id="from_email">                                
                            <div class="clearfix"></div>
                            <label class="col-md-3 col-xs-12">Friend's email:</label>
                            <input class="col-md-4" type="email" id="to_email">                                
                            <div class="clearfix"></div>
                            <button class="col-md-offset-3 col-md-2 btn btn-default" id="send_femail">Send</button>
                        </div>
                        {% if post.price and post.owner != user %}
                        <div class="main-product-btn">
                            <div class="col-xs-6 col-md-3 no-padding">
                                <input class="btn btn-info btn-payment" type="button" value="Purchase">
                            </div>  
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>            
            
        </div>
    </div>

    <div id="pay-modal" class="perk-modal modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
        <form action="" method="post" class="ads-pay-form">
          {% csrf_token %}
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">{{ post.title }}</h4>
          </div>
          <div class="modal-body">
            <div class="modal-price">Price: <b>${{ post.price }}</b> USD</div>
            <div class="form-group" style="padding: 12px;">
                <div class="radio">
                  <label title="Direct pay to owner"><input style="margin-top: -1px;" type="radio" name="optpay" value="direct" checked="">Direct Pay</label>
                </div>
                <div class="radio">
                  <label title="Put money on escrow until you approve it"><input style="margin-top: -1px;" type="radio" name="optpay" value="escrow">Put on escrow</label>
                </div>
            </div>
            <div class="form-group">
                <label>Contact Information</label>
                <small>Please provide email, phone number, address ...</small>
                <textarea class="form-control" name="contact" rows=4>{{ user.email }}&#13;&#10;{% if user.phone %}{{ user.phone }}{% endif %}&#13;&#10;{% if user.address %}{{ user.address }}{% endif %}
                </textarea>
            </div>            
            <input type="hidden" name="stripeToken" id="stripe_token">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" id="btn-pay">CONTINUE</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">CLOSE</button>
          </div>
        </form>
        </div>

      </div>
    </div>      

    <div id="result-modal" class="modal fade perk-modal" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Purchase an Item</h4>
          </div>
        <form id="rate-form">
        <div class="modal-body" style="font-size: 16px; line-height: 22px;">
            <div class="well">
                <p>Thank you for your purchase</p>
                <p>Transaction ID: {{ result }}</p>
            </div>
                <h4>Please rate the item</h4>
                <div style="padding: 10px 0;">
                    <input id="rating-input" name="rating" type="text" title="" value="5"/>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea class="form-control" name="content" rows=4 required=""></textarea>
                </div>            
                <input type="hidden" name="post_id" value="{{ post.id }}">
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn" id="btn-rate">Rate</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </form>
        </div>

      </div>
    </div>
{% endblock %}

{% block load_highcharts_js %}
{% endblock %}

{% block own_js %}
<script src="https://checkout.stripe.com/checkout.js"></script>
<script src="/static/star-rating/star-rating.min.js"></script>

<script type="text/javascript">
    var re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

    $('#rating-input').rating({
        min: 0,
        max: 5,
        step: 0.5,
        size: 'xs',
        showClear: false,
        showCaption: false
    });

    $('#rating-owner').rating({
        min: 0,
        max: 5,
        step: 0.5,
        size: 'xs',
        showClear: false,
        showCaption: false,
        displayOnly: true
    });

    {% if post.price %}
        var transaction = '{{ result }}';
        if (transaction)
            $('#result-modal').modal();
    
        var loggedin = '{{ user.is_authenticated }}';

        var price = {{ post.price }} * 100; 

        var handler = StripeCheckout.configure({
            key: '{{ skey }}',
            locale: 'auto',
            token: function(token) {
                $('#stripe_token').val(token.id);
                $(".ads-pay-form").submit();
            }
        });

        $('#btn-pay').on('click', function(e) {
            handler.open({
                name: "Globalboard",
                description: "{{ post.title }}",
                currency: "usd",
                amount: price
            });
            e.preventDefault();
        });

        // Close Checkout on page navigation:
        $(window).on('popstate', function() {
            handler.close();
        });

        $('.btn-payment').click(function() {
            if(loggedin == 'False') {
                alert('Please login and process payment!');
                location.href = '/accounts/login?next={{ request.path }}';
                return;
            }

            $('#pay-modal').modal();
        });

        $('#rate-form').submit(function(e) {
            e.preventDefault();

            jQuery.ajax({
                type: 'post',
                url: '/rate_ads',
                data: $(this).serialize(),
                success: function(res) {
                    alert('Thank you for your rating.');
                    $('#result-modal').modal('hide');
                }
            }); 
        });
    {% endif %}

    function set_image(obj) {
        var img = $(obj).attr('src');
        $('.first_image').attr('src', img);
    }

    $('.email_to_friend').click(function() {
        $('.femail_body').toggleClass('hidden');
    })

    $('button.btn-reply').click(function() {
        $('.reply-post').toggleClass('hidden');
    })

    $('#send_femail').click(function() {
        var from_email = $('#from_email').val();
        var to_email = $('#to_email').val();

        if (!re.test(from_email)) {
            alert('Please provide a valid email!');
            $('#from_email').focus();
            return;
        }

        if (!re.test(to_email)) {
            alert('Please provide a valid email!');
            $('#to_email').focus();
            return
        }
        
        jQuery.ajax({
            type: 'post',
            url: '/send_friend_email',
            data: {
                ads_id: {{ post.id }},
                from_email: from_email,
                to_email: to_email
            },
            success: function(data) {
                alert('Email sent successfully!');
                $('.femail_body').toggleClass('hidden');
            }
        });

    });

    $('#send_remail').click(function() {
        var from_email = $('#from_remail').val();
        var content = $('#reply-body').val().trim();

        if (!re.test(from_email)) {
            alert('Please provide a valid email!');
            $('#from_remail').focus();
            return;
        }
        
        if (content == '') {
            alert('Please provide some content!');
            $('#reply-body').focus();
            return;
        }

        jQuery.ajax({
            type: 'post',
            url: '/send_reply_email',
            data: {
                ads_id: {{ post.id }},
                from_email: from_email,
                content: content
            },
            success: function(data) {
                alert('Reply email sent successfully!');
                $('.reply-post').toggleClass('hidden');
            }
        });

    });

    $('.favourite').click(function() {
        var tthis = this;
        jQuery.ajax({
            type: 'post',
            url: '/toggle_favourite',
            data: {
                ads_id: {{ post.id }},
            },
            success: function(res) {
                if (res == 'success') {
                    $(tthis).toggleClass('like');                    
                } else {
                    alert('You need to login for saving this in your favourites.');
                }
            }
        });        
    });
</script>
{% endblock %}